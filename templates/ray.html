<!DOCTYPE html>
{% autoescape true %}
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <title>ray</title>
    <style>
      .heading {
        font-size: 1.5em;
        font-weight: bold
      }
      input { 
        text-align: right; 
      }
    </style>
    <script>
      'use strict';
      function updateItemDisplay(selectId, divId, expected) {
        var select = document.getElementById(selectId);
        var div = document.getElementById(divId);
        var visible = select.options[select.selectedIndex].value === expected;
        div.style.display = visible ? 'inline' : 'none';
      }

      function updateCoordinates(item) {
        var path = document.getElementById(item + '_path').value.trim();
        var isClosed = path.endsWith('z') || path.endsWith('Z');
        var element = document.createElementNS("http://www.w3.org/2000/svg", "path");
        element.setAttribute('d', path);
        var length = element.getTotalLength();

        function clamp(percentage) {
          if (isClosed) {
            percentage = percentage % 100;
            if (percentage < 0)
              percentage += 100;
          } else {
            if (percentage < 0)
              percentage = 0;
            else if (percentage > 100)
              percentage = 100;
          }
          return percentage;
        }

        function locate(percentage, xId, yId) {
          // https://drafts.fxtf.org/motion-1/#calculating-the-computed-distance-along-a-path
          var distance = length * clamp(percentage) / 100;
          return element.getPointAtLength(distance);
        }

        var epsilon = 0.001;
        var percentage = clamp(Number(document.getElementById(item + '_distance').value.trim()));

        var previous = locate(percentage - epsilon, item + '_x0', item + '_y0');
        var current = locate(percentage, item + '_x1', item + '_y1');
        var next = locate(percentage + epsilon, item + '_x2', item + '_y2');

        document.getElementById(item + '_path_x').value = current.x;
        document.getElementById(item + '_path_y').value = current.y;
        document.getElementById(item + '_path_dx').value = next.x - previous.x;
        document.getElementById(item + '_path_dy').value = next.y - previous.y;
      }

      window.onload = function() {
        updateItemDisplay('item1_display', 'item1_specification', 'block');
        updateItemDisplay('item2_display', 'item2_specification', 'block');
        updateItemDisplay('item3_display', 'item3_specification', 'block');
        updateItemDisplay('item4_display', 'item4_specification', 'block');
        updateItemDisplay('item5_display', 'item5_specification', 'block');
        updateItemDisplay('item6_display', 'item6_specification', 'block');

        updateItemDisplay('item1_function', 'item1_ray_specification', 'ray');
        updateItemDisplay('item2_function', 'item2_ray_specification', 'ray');
        updateItemDisplay('item3_function', 'item3_ray_specification', 'ray');
        updateItemDisplay('item4_function', 'item4_ray_specification', 'ray');
        updateItemDisplay('item5_function', 'item5_ray_specification', 'ray');
        updateItemDisplay('item6_function', 'item6_ray_specification', 'ray');

        updateItemDisplay('item1_function', 'item1_path_specification', 'path');
        updateItemDisplay('item2_function', 'item2_path_specification', 'path');
        updateItemDisplay('item3_function', 'item3_path_specification', 'path');
        updateItemDisplay('item4_function', 'item4_path_specification', 'path');
        updateItemDisplay('item5_function', 'item5_path_specification', 'path');
        updateItemDisplay('item6_function', 'item6_path_specification', 'path');

        updateItemDisplay('item1_anchor', 'item1_anchor_specification', '');
        updateItemDisplay('item2_anchor', 'item2_anchor_specification', '');
        updateItemDisplay('item3_anchor', 'item3_anchor_specification', '');
        updateItemDisplay('item4_anchor', 'item4_anchor_specification', '');
        updateItemDisplay('item5_anchor', 'item5_anchor_specification', '');
        updateItemDisplay('item6_anchor', 'item6_anchor_specification', '');
      }
    </script>
  </head>
  <body>
    <form method="post" action="/ray/plot">
      {% for item in items %}
        {% autoescape false %}
        {{ item }}
        {% endautoescape %}
      {% endfor %}
      <input type="submit" value="Plot"></input>
    </form>
  </body>
</html>
{% endautoescape %}
